<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Opulence Construction Dashboard</title>
  <style>
    * { margin:0; padding:0; box-sizing:border-box; }
    body {
      font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
      /* Updated background: dark grey with a subtle blue tint */
      background: #0e1116;
      background-image:
        radial-gradient(1200px 600px at 20% 15%, rgba(56, 102, 163, 0.18), transparent 60%),
        radial-gradient(1000px 520px at 78% 85%, rgba(34, 80, 140, 0.14), transparent 65%);
      min-height: 100vh; color:#333;
    }
    .container { max-width:1200px; margin:0 auto; padding:2rem; }
    .header {
      position: relative;
      background: rgba(255,255,255,0.08);           /* light gray glass */
      border: 1px solid rgba(255,255,255,0.18);     /* subtle border */
      backdrop-filter: blur(16px) saturate(120%);   /* liquid glass effect */
      padding:2rem; border-radius:16px; margin-bottom:1rem;
      box-shadow: inset 0 1px 0 rgba(255,255,255,0.06),
                  0 20px 60px rgba(0,0,0,0.25),     /* depth */
                  0 2px 10px rgba(0,0,0,0.15);
      text-align:center;
    }
    .header::before {
      content:"";
      position:absolute; inset:0; border-radius:16px; pointer-events:none;
      background:
        linear-gradient(180deg, rgba(255,255,255,.12), transparent 30%),
        linear-gradient(90deg, rgba(255,255,255,.06), transparent 40% 60%, rgba(255,255,255,.05));
    }
    .header h1 { color:#ffffff; font-size:2.5rem; margin-bottom:.5rem; }
    .header p  { color:#e5e7eb; font-size:1.1rem; }
    .topnav {
      display:flex; gap:.5rem; justify-content:center; flex-wrap:wrap;
      margin-bottom:1rem;
    }
    /* Glassy, dark-themed buttons */
    .topnav button {
      border: 1px solid rgba(255,255,255,0.18);
      background: rgba(255,255,255,0.08);
      color: #e5e7eb;
      padding: .6rem 1rem;
      border-radius: 12px;
      cursor: pointer;
      font-weight: 600;
      backdrop-filter: blur(12px) saturate(120%);
      box-shadow:
        inset 0 1px 0 rgba(255,255,255,0.06),
        0 8px 24px rgba(0,0,0,0.25),
        0 2px 10px rgba(0,0,0,0.15);
      transition: transform .12s ease, background .2s ease, border-color .2s ease, box-shadow .2s ease, color .2s ease;
    }
    .topnav button:hover {
      transform: translateY(-1px);
      background: rgba(255,255,255,0.12);
      border-color: rgba(255,255,255,0.28);
      box-shadow:
        inset 0 1px 0 rgba(255,255,255,0.08),
        0 12px 32px rgba(0,0,0,0.28),
        0 2px 12px rgba(0,0,0,0.18);
    }
    .topnav button:focus-visible {
      outline: none;
      box-shadow:
        0 0 0 2px rgba(96,165,250,0.5),
        inset 0 1px 0 rgba(255,255,255,0.08),
        0 10px 28px rgba(0,0,0,0.25);
    }
    .topnav button.active {
      background: linear-gradient(135deg, rgba(96,165,250,0.30), rgba(139,92,246,0.30));
      border-color: rgba(96,165,250,0.55);
      color: #ffffff;
      box-shadow:
        0 0 0 1px rgba(96,165,250,0.18) inset,
        0 14px 40px rgba(37,99,235,0.28),
        0 2px 10px rgba(0,0,0,0.18);
    }
    .dashboard-space {
      position: relative;
      background: rgba(255,255,255,0.08);
      border: 1px solid rgba(255,255,255,0.18);
      backdrop-filter: blur(16px) saturate(120%);
      padding:3rem; border-radius:16px; 
      box-shadow: inset 0 1px 0 rgba(255,255,255,0.06),
                  0 20px 60px rgba(0,0,0,0.25),
                  0 2px 10px rgba(0,0,0,0.15);
      min-height:600px; display:flex; align-items:center; justify-content:center; text-align:center;
    }
    .dashboard-space::before {
      content:"";
      position:absolute; inset:0; border-radius:16px; pointer-events:none;
      background:
        linear-gradient(180deg, rgba(255,255,255,.12), transparent 30%),
        linear-gradient(90deg, rgba(255,255,255,.06), transparent 40% 60%, rgba(255,255,255,.05));
    }
    .dashboard-placeholder { color:#e5e7eb; font-size:1.2rem; }
    .dashboard-placeholder .icon { color:#c7d2fe; opacity:.8; font-size:4rem; margin-bottom:1rem; }
    .loader {
      display:inline-block; width:40px; height:40px; border:4px solid #e5e7eb;
      border-top-color:#4f46e5; border-radius:50%; animation:spin 1s linear infinite;
      margin-bottom:1rem;
    }
    @keyframes spin { to { transform: rotate(360deg); } }

    /* Voice Status Indicator */
    .voice-status {
      position:fixed; top:30px; right:30px; background:rgba(0,0,0,0.8);
      color:#fff; padding:1rem 1.5rem; border-radius:25px;
      backdrop-filter:blur(10px); display:none; z-index:1001;
    }
    .voice-status.show { display:block; animation:slideDown .3s ease; }
    @keyframes slideDown { from{transform:translateY(-100%);opacity:0} to{transform:translateY(0);opacity:1} }

    /* Mobile */
    @media (max-width: 768px) {
      .container { padding:1rem; }
      .header h1 { font-size:2rem; }
      .header p { font-size:1rem; }
      .dashboard-space { padding:2rem; min-height:400px; }
    }
  </style>
</head>
<body>
  <div class="container">
    <!-- Header -->
    <div class="header">
      <h1>Opulence for Construction</h1>
      <p>Voice-Controlled Construction Dashboard</p>
    </div>

    <!-- Simple top nav to test loading dashboards -->
    <div class="topnav" id="topnav">
      <button data-view="overview" class="active">Overview</button>
      <button data-view="schedule">Schedule</button>
      <button data-view="crew">Crew</button>
      <button data-view="problems">Problems</button>
    </div>

    <!-- Dashboard Space -->
    <div class="dashboard-space" id="dashboardSpace">
      <div class="dashboard-placeholder">
        <div class="icon">üìä</div>
        <p>Dashboard components will be added here</p>
        <p><em>Click a tab above or use the voice agent to load a view</em></p>
      </div>
    </div>
  </div>

  <!-- Voice Assistant Widget -->
  <vapi-widget
    public-key="1f96e572-7a5b-4b45-ba8b-0dc2721ca738"
    assistant-id="d2572015-8bb2-4043-8913-87400a590bc5"
    mode="voice" theme="dark"
    base-bg-color="#000000" accent-color="#14B8A6"
    cta-button-color="#000000" cta-button-text-color="#ffffff"
    border-radius="large" size="full" position="bottom-right"
    title="TALK WITH AI" start-button-text="Start" end-button-text="End Call"
    chat-first-message="Hey, How can I help you today?"
    chat-placeholder="Type your message..." voice-show-transcript="true"
    consent-required="true" consent-title="Terms and conditions"
    consent-content="By clicking 'Agree,' and each time I interact with this AI agent, I consent to the recording, storage, and sharing of my communications with third-party service providers, and as otherwise described in our Terms of Service."
    consent-storage-key="vapi_widget_consent">
  </vapi-widget>

  <!-- Voice Status Indicator -->
  <div class="voice-status" id="voiceStatus">Voice assistant ready</div>

  <!-- Vapi Voice Widget SDK -->
  <script src="https://unpkg.com/@vapi-ai/client-sdk-react/dist/embed/widget.umd.js" async type="text/javascript"></script>

  <script>
    // -------------------------------
    // Optional: global config for fragments to read
    // -------------------------------
    window.OPULENCE = window.OPULENCE || {
      // proxyUrl: "/api/crew",
      // airtableApiKey: "YOUR_API_KEY",
      // baseId: "YOUR_BASE_ID",
      // crewTable: "Crew",
      // projectsTable: "Projects",
      // issuesTable: "Issues",
      // milestonesTable: "Milestones",
      // tasksTable: "Tasks"
    };

    // -------------------------------
    // Mini router: load partials into #dashboardSpace
    // -------------------------------
    const VIEW_MAP = {
      overview: 'Components/overview.html',
      schedule: 'Components/schedule.html',
      crew:     'Components/crew.html',
      problems: 'Components/problems.html'
    };

    const spaceEl = document.getElementById('dashboardSpace');
    const navEl = document.getElementById('topnav');

    async function loadDashboard(name) {
      const file = VIEW_MAP[name];
      if (!file) {
        console.warn('Unknown dashboard:', name);
        return;
      }

      // update active nav state
      if (navEl) {
        [...navEl.querySelectorAll('button')].forEach(b => {
          b.classList.toggle('active', b.dataset.view === name);
        });
      }

      // loading UI
      spaceEl.innerHTML = `
        <div>
          <div class="loader" aria-label="Loading"></div>
          <div style="color:#6b7280">Loading ${name}‚Ä¶</div>
        </div>
      `;

      try {
        const res = await fetch(file, { cache: 'no-store' });
        if (!res.ok) throw new Error(`Failed to load ${file} (${res.status})`);
        const html = await res.text();
        spaceEl.innerHTML = html;
        executeScripts(spaceEl);

        if (window.afterDashboardLoad) window.afterDashboardLoad(name);

        // Auto-init: trigger GET on supported dashboards as soon as they load
        const AUTO_INIT = new Set(['crew','overview','schedule','problems']);
        if (AUTO_INIT.has(name)) {
          setTimeout(() => {
            const btn = spaceEl.querySelector('#getBtn');
            if (btn && !btn.disabled) btn.click();
          }, 50);
        }

        // maintain SPA deep-link format (/#/crew)
        location.hash = `#/${name}`;
      } catch (err) {
        console.error(err);
        spaceEl.innerHTML = `
          <div class="dashboard-placeholder">
            <div class="icon">‚ö†Ô∏è</div>
            <p>Couldn't load <strong>${name}</strong> view.</p>
            <p style="color:#6b7280">${String(err.message || err)}</p>
          </div>
        `;
      }
    }

    function executeScripts(container) {
      const scripts = container.querySelectorAll("script");
      scripts.forEach(script => {
        const newScript = document.createElement("script");
        if (script.src) {
          newScript.src = script.src;
        } else {
          newScript.textContent = script.innerHTML;
        }
        document.body.appendChild(newScript);
        document.body.removeChild(newScript);
      });
    }

    // Expose for voice agent or other scripts
    window.loadDashboard = loadDashboard;

    // Top nav clicks
    if (navEl) {
      navEl.addEventListener('click', (e) => {
        const btn = e.target.closest('button[data-view]');
        if (!btn) return;
        loadDashboard(btn.dataset.view);
      });
    }

    // Deep-link on refresh (/#/crew)
    function bootFromHash() {
      const match = location.hash.match(/^#\/([a-z0-9_-]+)/i);
      const view = match ? match[1] : null;
      if (view && VIEW_MAP[view]) {
        loadDashboard(view);
      }
    }
    window.addEventListener('hashchange', bootFromHash);
    bootFromHash(); // run once

    // -------------------------------
    // Voice Status + widget bridge
    // -------------------------------
    function showVoiceStatus(message) {
      const voiceStatus = document.getElementById('voiceStatus');
      if (!voiceStatus) return;
      voiceStatus.textContent = message;
      voiceStatus.classList.add('show');
      setTimeout(() => voiceStatus.classList.remove('show'), 3000);
    }

    // Helper: extract a view name from arbitrary payload shapes
    function extractView(payload) {
      if (!payload) return null;
      const pick = v => (v && typeof v === 'string') ? v.toLowerCase() : null;
      return (
        pick(payload.view) ||
        pick(payload.name) ||
        pick(payload.targetView) ||
        pick(payload.target) ||
        pick(payload.command) ||
        pick(payload.action && payload.action.view) ||
        pick(payload.intent && payload.intent.view) ||
        pick(payload.payload && payload.payload.view) ||
        pick(payload.metadata && (payload.metadata.view || payload.metadata.loadDashboard)) ||
        null
      );
    }

    // Listen for Vapi widget events + custom bridge
    window.addEventListener('message', function(event) {
      try {
        // Vapi events
        if (event.data && event.data.type === 'vapi-widget') {
          switch (event.data.event) {
            case 'call-start': showVoiceStatus('üé§ Voice call started'); break;
            case 'call-end':   showVoiceStatus('üëã Voice call ended'); break;
            case 'message': {
              const msg = event.data.message || {};
              if (msg.transcript) showVoiceStatus(`"${msg.transcript}"`);
              const v = extractView(msg) || extractView(msg.data) || extractView(msg.metadata);
              if (v && VIEW_MAP[v]) {
                loadDashboard(v);
                showVoiceStatus(`Switching to ${v}`);
              }
              break;
            }
          }
        }
        // Custom bridge (backward compatible)
        if (event.data && event.data.type === 'opulence') {
          const v = extractView(event.data) || extractView(event.data.payload) || extractView(event.data.action);
          if (v && VIEW_MAP[v]) loadDashboard(v);
        }
      } catch (e) {
        console.warn('[voice] postMessage parse error:', e?.message || e);
      }
    });

    console.log('Opulence Dashboard initialized - Voice widget ready');
  </script>

  <!-- Voice-driven view switching (polls /api/voice-intent and ONLY swaps the in-page view) -->
  <script>
  (function(){
    const ALLOWED = new Set(['overview','schedule','crew','problems']);
    let lastToken = null;
    let lastView = null;

    async function loadView(view){
      if (typeof window.loadDashboard === 'function') return window.loadDashboard(view);
      const el = document.querySelector(`[data-view="${view}"]`);
      if (el && typeof el.click === 'function') return el.click();
      const container = document.getElementById('dashboardSpace');
      if (!container) { console.warn('[voice] dashboard container not found'); return; }
      const url = `Components/${view}.html`;
      const r = await fetch(url, { cache:'no-store' });
      if (!r.ok) throw new Error(`Failed to load ${url}: ${r.status}`);
      container.innerHTML = await r.text();
    }

    function extractView(obj){
      if (!obj) return null;
      const pick = v => (v && typeof v === 'string') ? v.toLowerCase() : null;
      return (
        pick(obj.view) ||
        pick(obj.name) ||
        pick(obj.intent && obj.intent.view) ||
        pick(obj.action && obj.action.view) ||
        pick(obj.payload && obj.payload.view) ||
        pick(obj.targetView) ||
        pick(obj.target) ||
        pick(obj.command) ||
        null
      );
    }

    function extractToken(obj){
      return obj.updatedAt ?? obj.ts ?? obj.time ?? obj.version ?? obj.rev ?? obj.revision ?? null;
    }

    async function poll(){
      try{
        const u = new URL('/api/voice-intent', location.origin);
        if (lastToken != null) u.searchParams.set('since', String(lastToken));

        const res = await fetch(u.toString(), { cache:'no-store' });
        if (!res.ok) return;
        const j = await res.json();

        const token = extractToken(j);
        const view = extractView(j);

        // Treat as changed if:
        // - backend flags changed, or
        // - token advanced, or
        // - view differs from lastView
        const changed = Boolean(j.changed) || (token != null && token !== lastToken) || (view && view !== lastView);

        if (view && ALLOWED.has(view) && changed) {
          await loadView(view);
          document.documentElement.setAttribute('data-active-view', view);
          lastView = view;
          if (token != null) lastToken = token;
          try { showVoiceStatus(`Switched to ${view}`); } catch {}
        } else if (token != null && token !== lastToken) {
          lastToken = token; // progress token even if no recognized view
        }
      } catch (e) {
        console.warn('[voice] poll error:', e?.message || e);
      }
    }

    try { clearInterval(window._voicePollTimer); } catch {}
    window._voicePollTimer = setInterval(poll, 2000);
  })();
  </script>
</body>
</html>
