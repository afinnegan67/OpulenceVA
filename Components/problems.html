<div style="padding:16px;font-family:system-ui,Arial,sans-serif;">
  <h3>Problems (Airtable)</h3>
  <p>Click “Get” to fetch live data from the Problems table via the API.</p>

  <div style="margin-bottom:12px;">
    <button id="getBtn" style="padding:8px 12px;border:none;border-radius:8px;background:#4f46e5;color:#fff;cursor:pointer;">Get</button>
    <span id="status" style="margin-left:10px;color:#6b7280;display:none;"></span>
  </div>

  <pre id="output" style="background:#0b1021;color:#cbd5e1;padding:12px;border-radius:8px;white-space:pre-wrap;word-break:break-word;min-height:160px;overflow:auto;"></pre>
</div>

<script>
(function(){
  // Optional overrides (safe): window.OPULENCE = { baseId: 'app...', problemsTableId: 'tbl...' };
  const cfg = window.OPULENCE || {};

  // Use local Express when running via Live Server; otherwise use Vercel serverless route
  const isLocalStatic = ['localhost','127.0.0.1'].includes(location.hostname);
  const baseApi = isLocalStatic ? 'http://localhost:3000/api/problems' : '/api/problems';

  const getBtn = document.getElementById('getBtn');
  const statusEl = document.getElementById('status');
  const output = document.getElementById('output');

  function buildUrl() {
    const u = new URL(baseApi, window.location.origin);
    if (cfg.baseId) u.searchParams.set('baseId', cfg.baseId);
    if (cfg.problemsTableId) u.searchParams.set('problemsTableId', cfg.problemsTableId);
    if (cfg.problemsTableName) u.searchParams.set('problemsTableName', cfg.problemsTableName);
    // You can also set extras: view, maxRecords, returnFieldsByFieldId=true
    return u.toString();
  }

  async function getProblems() {
    try {
      getBtn.disabled = true;
      getBtn.textContent = 'Loading…';
      statusEl.style.display = 'inline';
      statusEl.style.color = '#6b7280';
      statusEl.textContent = 'Fetching from API…';
      output.textContent = '';

      const url = buildUrl();
      const r = await fetch(url, { cache: 'no-store' });
      if (!r.ok) {
        const txt = await r.text();
        throw new Error(`HTTP ${r.status}: ${txt}`);
      }
      const data = await r.json();

      // Pretty-print the raw Airtable payload we returned ({ records: [...] })
      output.textContent = JSON.stringify(data, null, 2);
      statusEl.style.color = '#059669';
      statusEl.textContent = `Done. ${Array.isArray(data.records) ? data.records.length : 0} records.`;
    } catch (e) {
      statusEl.style.color = '#e11d48';
      statusEl.textContent = `Error: ${e.message}`;
      output.textContent = '';
      console.error(e);
    } finally {
      getBtn.disabled = false;
      getBtn.textContent = 'Get';
    }
  }

  getBtn.addEventListener('click', getProblems);
})();
</script>
