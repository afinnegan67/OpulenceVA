<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Opulence Construction Dashboard</title>
  <style>
    * { margin:0; padding:0; box-sizing:border-box; }
    body { font-family:'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; background:linear-gradient(135deg,#667eea 0%,#764ba2 100%); min-height:100vh; color:#333; }
    .container { max-width:1200px; margin:0 auto; padding:2rem; }
    .header { background:rgba(255,255,255,0.95); backdrop-filter:blur(10px); padding:2rem; border-radius:16px; margin-bottom:1rem; box-shadow:0 8px 32px rgba(0,0,0,0.1); text-align:center; }
    .header h1 { color:#667eea; font-size:2.5rem; margin-bottom:.5rem; }
    .header p { color:#666; font-size:1.1rem; }
    .topnav { display:flex; gap:.5rem; justify-content:center; flex-wrap:wrap; margin-bottom:1rem; }
    .topnav button { border:1px solid rgba(255,255,255,.6); background:rgba(255,255,255,.85); padding:.5rem .9rem; border-radius:12px; cursor:pointer; color:#374151; font-weight:600; box-shadow:0 2px 10px rgba(0,0,0,.05); }
    .topnav button.active { border-color:#4f46e5; color:#4f46e5; }
    .dashboard-space { background:rgba(255,255,255,0.95); backdrop-filter:blur(10px); padding:3rem; border-radius:16px; box-shadow:0 8px 32px rgba(0,0,0,0.1); min-height:600px; display:flex; align-items:center; justify-content:center; text-align:center; }
    .dashboard-placeholder { color:#999; font-size:1.2rem; }
    .dashboard-placeholder .icon { font-size:4rem; margin-bottom:1rem; opacity:.5; }
    .loader { display:inline-block; width:40px; height:40px; border:4px solid #e5e7eb; border-top-color:#4f46e5; border-radius:50%; animation:spin 1s linear infinite; margin-bottom:1rem; }
    @keyframes spin { to { transform:rotate(360deg); } }
    .voice-status { position:fixed; top:30px; right:30px; background:rgba(0,0,0,0.8); color:#fff; padding:1rem 1.5rem; border-radius:25px; backdrop-filter:blur(10px); display:none; z-index:1001; }
    .voice-status.show { display:block; animation:slideDown .3s ease; }
    @keyframes slideDown { from{transform:translateY(-100%);opacity:0} to{transform:translateY(0);opacity:1} }
    @media (max-width:768px){ .container{padding:1rem;} .header h1{font-size:2rem;} .header p{font-size:1rem;} .dashboard-space{padding:2rem; min-height:400px;} }
  </style>
</head>
<body>
  <div class="container">
    <div class="header">
      <h1>üèóÔ∏è OPULENCE</h1>
      <p>Voice-Controlled Construction Dashboard</p>
    </div>
    <div class="topnav" id="topnav">
      <button data-view="overview" class="active">Overview</button>
      <button data-view="schedule">Schedule</button>
      <button data-view="crew">Crew</button>
      <button data-view="problems">Problems</button>
    </div>
    <div class="dashboard-space" id="dashboardSpace">
      <div class="dashboard-placeholder">
        <div class="icon">üìä</div>
        <p>Dashboard components will be added here</p>
        <p><em>Click a tab above or use the voice agent to load a view</em></p>
      </div>
    </div>
  </div>

  <vapi-widget
    public-key="1f96e572-7a5b-4b45-ba8b-0dc2721ca738"
    assistant-id="d2572015-8bb2-4043-8913-87400a590bc5"
    mode="voice" theme="dark"
    base-bg-color="#000000" accent-color="#14B8A6"
    cta-button-color="#000000" cta-button-text-color="#ffffff"
    border-radius="large" size="full" position="bottom-right"
    title="TALK WITH AI" start-button-text="Start" end-button-text="End Call"
    chat-first-message="Hey, How can I help you today?"
    chat-placeholder="Type your message..." voice-show-transcript="true"
    consent-required="true" consent-title="Terms and conditions"
    consent-content="By clicking 'Agree,' and each time I interact with this AI agent, I consent to the recording, storage, and sharing of my communications with third-party service providers, and as otherwise described in our Terms of Service."
    consent-storage-key="vapi_widget_consent">
  </vapi-widget>

  <div class="voice-status" id="voiceStatus">Voice assistant ready</div>

  <script src="https://unpkg.com/@vapi-ai/client-sdk-react/dist/embed/widget.umd.js" async type="text/javascript"></script>

  <!-- Simplified dashboard + voice polling script placed AFTER markup -->
  <script>
    window.OPULENCE = window.OPULENCE || {};
    const VIEW_MAP = { overview:'Components/overview.html', schedule:'Components/schedule.html', crew:'Components/crew.html', problems:'Components/problems.html' };
    const spaceEl = document.getElementById('dashboardSpace');
    const navEl = document.getElementById('topnav');

    async function loadDashboard(name){
      const file = VIEW_MAP[name]; if(!file) return;
      navEl?.querySelectorAll('button').forEach(b=>b.classList.toggle('active', b.dataset.view===name));
      spaceEl.innerHTML = `<div><div class="loader"></div><div style="color:#6b7280">Loading ${name}‚Ä¶</div></div>`;
      try { const r = await fetch(file,{cache:'no-store'}); if(!r.ok) throw new Error(`Failed to load ${file} (${r.status})`); const html = await r.text(); spaceEl.innerHTML = html; executeScripts(spaceEl); const AUTO_INIT=new Set(['crew','overview','schedule','problems']); if(AUTO_INIT.has(name)) setTimeout(()=>{ const btn=spaceEl.querySelector('#getBtn'); if(btn && !btn.disabled) btn.click(); },50); location.hash = `#/${name}`; }
      catch(e){ spaceEl.innerHTML = `<div class="dashboard-placeholder"><div class=icon>‚ö†Ô∏è</div><p>Couldn't load <strong>${name}</strong>.</p><p style=\"color:#6b7280\">${e.message}</p></div>`; }
    }
    function executeScripts(container){ container.querySelectorAll('script').forEach(sc=>{ const s=document.createElement('script'); if(sc.src) s.src=sc.src; else s.textContent=sc.innerHTML; document.body.appendChild(s); document.body.removeChild(s); }); }
    window.loadDashboard = loadDashboard;
    navEl?.addEventListener('click', e=>{ const btn=e.target.closest('button[data-view]'); if(btn) loadDashboard(btn.dataset.view); });
    function bootFromHash(){ const m=location.hash.match(/^#\/(\w+)/); const v=m&&m[1]; if(v && VIEW_MAP[v]) loadDashboard(v); }
    window.addEventListener('hashchange', bootFromHash); bootFromHash(); if(!location.hash) loadDashboard('overview');
    function showVoiceStatus(msg){ const el=document.getElementById('voiceStatus'); if(!el) return; el.textContent=msg; el.classList.add('show'); setTimeout(()=>el.classList.remove('show'),3000);}    
    window.addEventListener('message', ev=>{ const d=ev.data; if(!d) return; if(d.type==='vapi-widget'){ if(d.event==='call-start') showVoiceStatus('üé§ Voice call started'); else if(d.event==='call-end') showVoiceStatus('üëã Voice call ended'); else if(d.event==='message' && d.message?.transcript) showVoiceStatus(`"${d.message.transcript}"`); } if(d.type==='opulence' && d.action==='loadDashboard'){ const v=String(d.name||'').toLowerCase(); if(VIEW_MAP[v]) loadDashboard(v); }});
    (function(){ const ALLOWED=new Set(['overview','schedule','crew','problems']); let lastUpdate=0; async function poll(){ try{ const u=new URL('/api/voice-intent', location.origin); if(lastUpdate) u.searchParams.set('since', lastUpdate); const res=await fetch(u.toString(),{cache:'no-store'}); if(!res.ok) return; const j=await res.json(); if(j.updatedAt && j.updatedAt>lastUpdate) lastUpdate=j.updatedAt; const view=String(j.view||'').toLowerCase(); if(j.changed && ALLOWED.has(view)) loadDashboard(view); }catch(e){ console.warn('[voice] poll error', e.message);} } try{ clearInterval(window._voicePollTimer);}catch{} window._voicePollTimer=setInterval(poll,2000); })();
    window.voiceTest = async function(view){ try { const r=await fetch('/api/voice-intent',{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({view})}); const j=await r.json(); console.log('[voiceTest]', j); if(j.view && VIEW_MAP[j.view]) loadDashboard(j.view); } catch(e){ console.warn(e);} };
    console.log('Opulence Dashboard initialized (simplified mode)');
  </script>
</body>
</html>
