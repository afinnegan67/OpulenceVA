<div style="padding:16px;font-family:system-ui,Arial,sans-serif;">
  <h3>Overview (Airtable)</h3>
  <p>Click “Get” to fetch live data from the Overview table via the API.</p>

  <div style="margin-bottom:12px;display:flex;gap:8px;align-items:center;">
    <button id="getBtn" style="padding:8px 12px;border:none;border-radius:8px;background:#4f46e5;color:#fff;cursor:pointer;">Get</button>
    <span id="status" style="margin-left:4px;color:#6b7280;display:none;"></span>
  </div>

  <div id="cards" class="overview-cards"></div>
</div>

<style>
  .overview-cards {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(320px, 1fr));
    gap: 12px;
    margin-top: 8px;
  }
  .proj-card {
    background:#fff; border:1px solid #e5e7eb; border-radius:12px; padding:12px;
    box-shadow:0 4px 12px rgba(0,0,0,.04);
  }
  .proj-head {
    display:flex; align-items:center; gap:8px; margin-bottom:8px;
  }
  .proj-title { font-weight:700; color:#111827; }
  .badge {
    margin-left:auto; display:inline-block; font-size:12px; padding:2px 8px; border-radius:999px; color:#fff;
  }
  .status-in-progress { background:#3b82f6; }
  .status-done, .status-complete { background:#059669; }
  .status-todo, .status-not-started { background:#6b7280; }
  .proj-meta {
    display:grid; grid-template-columns: 1fr 1fr; gap:6px 12px; font-size:13px; color:#374151; margin-bottom:8px;
  }
  .proj-meta div span { color:#6b7280; }
  .progress {
    background:#f3f4f6; border:1px solid #e5e7eb; border-radius:999px; height:10px; overflow:hidden; margin-top:4px;
  }
  .bar { height:100%; background:#4f46e5; width:0%; transition:width .3s ease; }
  .money { color:#374151; font-size:13px; display:flex; gap:12px; margin-top:8px; }
</style>

<script>
(function(){
  const cfg = window.OPULENCE || {};
  const isLocalStatic = ['localhost','127.0.0.1'].includes(location.hostname);
  const baseApi = isLocalStatic ? 'http://localhost:3000/api/overview' : '/api/overview';

  const getBtn = document.getElementById('getBtn');
  const statusEl = document.getElementById('status');
  const cards = document.getElementById('cards');

  function buildUrl() {
    const u = new URL(baseApi, window.location.origin);
    if (cfg.baseId) u.searchParams.set('baseId', cfg.baseId);
    if (cfg.overviewTableId) u.searchParams.set('overviewTableId', cfg.overviewTableId);
    if (cfg.overviewTableName) u.searchParams.set('overviewTableName', cfg.overviewTableName);
    return u.toString();
  }

  function escapeHTML(s){
    return String(s||"").replace(/[&<>"']/g, m => ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#039;'}[m]));
  }
  function fmtDate(d){
    if (!d) return '—';
    const t = new Date(d);
    return isNaN(t) ? '—' : t.toLocaleDateString([], { month:'short', day:'numeric', year:'numeric' });
  }
  function statusClass(s){
    const k = String(s||'').toLowerCase().replace(/\s+/g,'-');
    if (k.includes('progress')) return 'status-in-progress';
    if (k.includes('done') || k.includes('complete')) return 'status-done';
    if (k.includes('todo') || k.includes('not-started')) return 'status-todo';
    return 'status-in-progress';
  }
  function percent(n){
    const v = Number.isFinite(+n) ? +n : 0;
    return Math.max(0, Math.min(100, v));
  }

  function renderCards(projects){
    if (!Array.isArray(projects) || !projects.length){
      cards.innerHTML = '<p style="color:#6b7280;text-align:center;padding:12px;">No projects found.</p>';
      return;
    }
    cards.innerHTML = projects.map(p => {
      const pct = percent(p.percentComplete);
      return `
        <div class="proj-card">
          <div class="proj-head">
            <div>
              <div class="proj-title">${escapeHTML(p.name || '—')}</div>
              <div style="color:#6b7280;font-size:12px;">${escapeHTML(p.projectId || '')}</div>
            </div>
            <span class="badge ${statusClass(p.status)}">${escapeHTML(p.status || '—')}</span>
          </div>

          <div class="proj-meta">
            <div><span>Client:</span> ${escapeHTML(p.client || '—')}</div>
            <div><span>Percent:</span> ${pct}%</div>
            <div><span>Start:</span> ${escapeHTML(fmtDate(p.startDate))}</div>
            <div><span>End:</span> ${escapeHTML(fmtDate(p.endDate))}</div>
          </div>

          <div class="progress" aria-label="Percent Complete" title="${pct}% complete">
            <div class="bar" style="width:${pct}%"></div>
          </div>

          <div class="money">
            <div><span style="color:#6b7280;">Budget:</span> ${escapeHTML(p.budget || '—')}</div>
            <div><span style="color:#6b7280;">Spent:</span> ${escapeHTML(p.spent || '—')}</div>
          </div>
        </div>
      `;
    }).join('');
  }

  async function getOverview() {
    try {
      getBtn.disabled = true;
      getBtn.textContent = 'Loading…';
      statusEl.style.display = 'inline';
      statusEl.style.color = '#6b7280';
      statusEl.textContent = 'Fetching from API…';
      cards.innerHTML = '';

      const url = buildUrl();
      const r = await fetch(url, { cache: 'no-store' });
      if (!r.ok) {
        const txt = await r.text();
        throw new Error(`HTTP ${r.status}: ${txt}`);
      }
      const data = await r.json();
      const projects = data.projects || [];

      renderCards(projects);

      statusEl.style.color = '#059669';
      statusEl.textContent = `Done. ${projects.length} projects.`;
    } catch (e) {
      statusEl.style.color = '#e11d48';
      statusEl.textContent = `Error: ${e.message}`;
      console.error(e);
      cards.innerHTML = '';
    } finally {
      getBtn.disabled = false;
      getBtn.textContent = 'Get';
    }
  }

  getBtn.addEventListener('click', getOverview);
})();
</script>
