<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Opulence Construction Dashboard</title>
  <style>
    * { margin:0; padding:0; box-sizing:border-box; }
    body {
      font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      min-height: 100vh; color:#333;
    }
    .container { max-width:1200px; margin:0 auto; padding:2rem; }
    .header {
      background:rgba(255,255,255,0.95); backdrop-filter:blur(10px);
      padding:2rem; border-radius:16px; margin-bottom:1rem;
      box-shadow:0 8px 32px rgba(0,0,0,0.1); text-align:center;
    }
    .header h1 { color:#667eea; font-size:2.5rem; margin-bottom:.5rem; }
    .header p { color:#666; font-size:1.1rem; }
    .topnav {
      display:flex; gap:.5rem; justify-content:center; flex-wrap:wrap;
      margin-bottom:1rem;
    }
    .topnav button {
      border:1px solid rgba(255,255,255,.6);
      background:rgba(255,255,255,.85);
      padding:.5rem .9rem; border-radius:12px; cursor:pointer;
      color:#374151; font-weight:600;
      box-shadow:0 2px 10px rgba(0,0,0,.05);
    }
    .topnav button.active { border-color:#4f46e5; color:#4f46e5; }
    .dashboard-space {
      background:rgba(255,255,255,0.95); backdrop-filter:blur(10px);
      padding:3rem; border-radius:16px; box-shadow:0 8px 32px rgba(0,0,0,0.1);
      min-height:600px; display:flex; align-items:center; justify-content:center; text-align:center;
    }
    .dashboard-placeholder { color:#999; font-size:1.2rem; }
    .dashboard-placeholder .icon { font-size:4rem; margin-bottom:1rem; opacity:.5; }
    .loader {
      display:inline-block; width:40px; height:40px; border:4px solid #e5e7eb;
      border-top-color:#4f46e5; border-radius:50%; animation:spin 1s linear infinite;
      margin-bottom:1rem;
    }
    @keyframes spin { to { transform: rotate(360deg); } }

    /* Voice Status Indicator */
    .voice-status {
      position:fixed; top:30px; right:30px; background:rgba(0,0,0,0.8);
      color:#fff; padding:1rem 1.5rem; border-radius:25px;
      backdrop-filter:blur(10px); display:none; z-index:1001;
    }
    .voice-status.show { display:block; animation:slideDown .3s ease; }
    @keyframes slideDown { from{transform:translateY(-100%);opacity:0} to{transform:translateY(0);opacity:1} }

    /* Mobile */
    @media (max-width: 768px) {
      .container { padding:1rem; }
      .header h1 { font-size:2rem; }
      .header p { font-size:1rem; }
      .dashboard-space { padding:2rem; min-height:400px; }
    }
  </style>
</head>
<body>
  <div class="container">
    <!-- Header -->
    <div class="header">
      <h1>üèóÔ∏è OPULENCE</h1>
      <p>Voice-Controlled Construction Dashboard</p>
    </div>

    <!-- Simple top nav to test loading dashboards -->
    <div class="topnav" id="topnav">
      <button data-view="overview" class="active">Overview</button>
      <button data-view="schedule">Schedule</button>
      <button data-view="crew">Crew</button>
      <button data-view="problems">Problems</button>
    </div>

    <!-- Dashboard Space -->
    <div class="dashboard-space" id="dashboardSpace">
      <div class="dashboard-placeholder">
        <div class="icon">üìä</div>
        <p>Dashboard components will be added here</p>
        <p><em>Click a tab above or use the voice agent to load a view</em></p>
      </div>
    </div>
  </div>

  <!-- Voice Assistant Widget -->
  <vapi-widget
    public-key="1f96e572-7a5b-4b45-ba8b-0dc2721ca738"
    assistant-id="d2572015-8bb2-4043-8913-87400a590bc5"
    mode="voice" theme="dark"
    base-bg-color="#000000" accent-color="#14B8A6"
    cta-button-color="#000000" cta-button-text-color="#ffffff"
    border-radius="large" size="full" position="bottom-right"
    title="TALK WITH AI" start-button-text="Start" end-button-text="End Call"
    chat-first-message="Hey, How can I help you today?"
    chat-placeholder="Type your message..." voice-show-transcript="true"
    consent-required="true" consent-title="Terms and conditions"
    consent-content="By clicking 'Agree,' and each time I interact with this AI agent, I consent to the recording, storage, and sharing of my communications with third-party service providers, and as otherwise described in our Terms of Service."
    consent-storage-key="vapi_widget_consent">
  </vapi-widget>

  <!-- Voice Status Indicator -->
  <div class="voice-status" id="voiceStatus">Voice assistant ready</div>

  <!-- Vapi Voice Widget SDK -->
  <script src="https://unpkg.com/@vapi-ai/client-sdk-react/dist/embed/widget.umd.js" async type="text/javascript"></script>

  <script>
    // -------------------------------
    // Optional: global config (Airtable/proxy) for fragments to read
    // -------------------------------
    window.OPULENCE = window.OPULENCE || {
      // proxyUrl: "/api/crew", // recommended for Airtable access
      // airtableApiKey: "YOUR_API_KEY",
      // baseId: "YOUR_BASE_ID",
      // crewTable: "Crew",
      // projectsTable: "Projects",
      // issuesTable: "Issues",
      // milestonesTable: "Milestones",
      // tasksTable: "Tasks"
    };

    // -------------------------------
    // Mini router: load partials into #dashboardSpace
    // -------------------------------
    const VIEW_MAP = {
      overview: 'Components/overview.html',
      schedule: 'Components/schedule.html',
      crew:     'Components/crew.html',
      problems: 'Components/problems.html'
    };

    const spaceEl = document.getElementById('dashboardSpace');
    const navEl = document.getElementById('topnav');

    async function loadDashboard(name) {
      const file = VIEW_MAP[name];
      if (!file) {
        console.warn('Unknown dashboard:', name);
        return;
      }

      if (navEl) {
        [...navEl.querySelectorAll('button')].forEach(b => {
          b.classList.toggle('active', b.dataset.view === name);
        });
      }

      spaceEl.innerHTML = `
        <div>
          <div class="loader" aria-label="Loading"></div>
          <div style="color:#6b7280">Loading ${name}‚Ä¶</div>
        </div>
      `;

      try {
        const res = await fetch(file, { cache: 'no-store' });
        if (!res.ok) throw new Error(`Failed to load ${file} (${res.status})`);
        const html = await res.text();
        spaceEl.innerHTML = html;
        executeScripts(spaceEl);
        
        if (window.afterDashboardLoad) window.afterDashboardLoad(name);
        location.hash = `#/${name}`;
      } catch (err) {
        console.error(err);
        spaceEl.innerHTML = `
          <div class="dashboard-placeholder">
            <div class="icon">‚ö†Ô∏è</div>
            <p>Couldn‚Äôt load <strong>${name}</strong> view.</p>
            <p style="color:#6b7280">${String(err.message || err)}</p>
          </div>
        `;
      }
    }

    function executeScripts(container) {
      const scripts = container.querySelectorAll("script");
      scripts.forEach(script => {
        const newScript = document.createElement("script");
        if (script.src) {
          newScript.src = script.src;
        } else {
          newScript.textContent = script.innerHTML;
        }
        document.body.appendChild(newScript);
        // Remove the script element after execution (optional)
        document.body.removeChild(newScript);
      });
    }

    // Expose for voice agent or other scripts
    window.loadDashboard = loadDashboard;

    // Top nav clicks
    if (navEl) {
      navEl.addEventListener('click', (e) => {
        const btn = e.target.closest('button[data-view]');
        if (!btn) return;
        loadDashboard(btn.dataset.view);
      });
    }

    // Deep-link on refresh (/#/crew)
    function bootFromHash() {
      const match = location.hash.match(/^#\/([a-z0-9_-]+)/i);
      const view = match ? match[1] : null;
      if (view && VIEW_MAP[view]) {
        loadDashboard(view);
      }
    }
    window.addEventListener('hashchange', bootFromHash);
    bootFromHash(); // run once

    // -------------------------------
    // Voice Status + bridge
    // -------------------------------
    function showVoiceStatus(message) {
      const voiceStatus = document.getElementById('voiceStatus');
      if (!voiceStatus) return;
      voiceStatus.textContent = message;
      voiceStatus.classList.add('show');
      setTimeout(() => voiceStatus.classList.remove('show'), 3000);
    }

    // Listen for Vapi widget events
    window.addEventListener('message', function(event) {
      // Vapi events (nice status toasts)
      if (event.data && event.data.type === 'vapi-widget') {
        switch (event.data.event) {
          case 'call-start': showVoiceStatus('üé§ Voice call started'); break;
          case 'call-end':   showVoiceStatus('üëã Voice call ended'); break;
          case 'message':
            if (event.data.message && event.data.message.transcript) {
              showVoiceStatus(`"${event.data.message.transcript}"`);
            }
            break;
        }
      }

      // Custom bridge: your agent can postMessage to load a view
      // example payload:
      // window.parent.postMessage({ type:'opulence', action:'loadDashboard', name:'crew' }, '*')
      if (event.data && event.data.type === 'opulence' && event.data.action === 'loadDashboard') {
        const name = String(event.data.name || '').toLowerCase();
        if (VIEW_MAP[name]) loadDashboard(name);
      }
    });

    console.log('Opulence Dashboard initialized - Voice widget ready');
  </script>

  <!-- Voice-driven view switching that keeps index.html shell and just swaps the dashboard content -->
  <script>
  (function(){
    const ALLOWED = new Set(['overview','schedule','crew','problems']);
    let lastUpdate = 0;

    // Resolve your dashboard container (adjust selectors to your shell if needed)
    function getContainer(){
      return document.getElementById('dashboard-container')
          || document.querySelector('[data-dashboard-container]')
          || document.getElementById('dashboard')
          || document.getElementById('content');
    }

    // Fallback loader: fetch component HTML and inject into the container
    async function fetchAndInject(view){
      const container = getContainer();
      if (!container) {
        console.warn('[voice] dashboard container not found');
        return;
      }
      const url = `/Components/${view}.html`;
      const r = await fetch(url, { cache:'no-store' });
      if (!r.ok) throw new Error(`Failed to load ${url}: ${r.status}`);
      container.innerHTML = await r.text();
      // Optional: notify components
      try { window.dispatchEvent(new CustomEvent('dashboard:view-loaded', { detail:{ view } })); } catch {}
    }

    // Unified loader that prefers your app‚Äôs existing helpers (if any)
    async function loadView(view){
      if (typeof window.loadDashboardView === 'function') return window.loadDashboardView(view);
      if (typeof window.setActiveTab === 'function') return window.setActiveTab(view);
      // Try simulating an existing tab
      const el = document.querySelector(`[data-view="${view}"]`) || document.getElementById(`${view}Tab`);
      if (el && typeof el.click === 'function') { el.click(); return; }
      // Fallback: fetch and inject
      return fetchAndInject(view);
    }

    // Poll the voice intent endpoint
    async function poll(){
      try{
        const u = new URL('/api/voice-intent', location.origin);
        if (lastUpdate) u.searchParams.set('since', String(lastUpdate));
        const res = await fetch(u.toString(), { cache:'no-store' });
        if (!res.ok) return;
        const j = await res.json();
        if (j.updatedAt && j.updatedAt > lastUpdate) lastUpdate = j.updatedAt;

        const view = String(j.view||'').toLowerCase();
        if (j.changed && ALLOWED.has(view)) {
          await loadView(view);
          // Reflect active view for styling if you use it
          try { document.documentElement.setAttribute('data-active-view', view); } catch {}
        }
      }catch(e){
        console.warn('[voice] poll error:', e?.message || e);
      }
    }

    // Stop any previous redirect-based poller and start this one
    try { clearInterval(window._voicePollTimer); } catch {}
    window._voicePollTimer = setInterval(poll, 2000);
  })();
  </script>
</body>
</html>
        }
      } catch (err) {
        console.warn('[voice] poll error:', err?.message || err);
      }
    }

    // Start polling every 2s; clear older nav-based interval if present
    try { clearInterval(window._voicePollTimer); } catch {}
    pollTimer = setInterval(checkViewChange, 2000);
    window._voicePollTimer = pollTimer;
  })();
  </script>
</body>
</html>
