<div style="padding:16px;font-family:system-ui,Arial,sans-serif;">
  <h3>Problems (Airtable)</h3>
  <p>Click “Get” to fetch live data from the Problems table via the API.</p>

  <div style="margin-bottom:12px;">
    <button id="getBtn" style="padding:8px 12px;border:none;border-radius:8px;background:#4f46e5;color:#fff;cursor:pointer;">Get</button>
    <span id="status" style="margin-left:10px;color:#6b7280;display:none;"></span>
  </div>

  <!-- Structured list -->
  <div id="cards" class="problems-cards"></div>
</div>

<style>
  .problems-cards {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(280px, 1fr));
    gap: 12px;
    margin-top: 8px;
  }
  .problem-card {
    background: #fff;
    border: 1px solid #e5e7eb;
    border-radius: 12px;
    padding: 12px;
    box-shadow: 0 4px 12px rgba(0,0,0,.04);
  }
  .problem-card .card-head {
    display: flex;
    justify-content: space-between;
    align-items: center;
    gap: 8px;
    margin-bottom: 8px;
  }
  .problem-card .pid {
    font-weight: 700;
    color: #111827;
  }
  .badge {
    display: inline-block;
    font-size: 12px;
    padding: 2px 8px;
    border-radius: 999px;
    color: #fff;
    line-height: 1.6;
    white-space: nowrap;
  }
  .badge.status-open { background:#e11d48; }
  .badge.status-in-progress { background:#f59e0b; }
  .badge.status-resolved { background:#059669; }
  .badge.sev-high { background:#dc2626; }
  .badge.sev-medium { background:#f59e0b; }
  .badge.sev-low { background:#10b981; }
  .problem-card .meta {
    display: grid;
    grid-template-columns: 1fr 1fr;
    gap: 6px 12px;
    font-size: 13px;
    color:#374151;
    margin-bottom: 8px;
  }
  .problem-card .meta div span {
    color:#6b7280;
  }
  .problem-card .desc {
    background:#f9fafb;
    border:1px solid #f3f4f6;
    border-radius:8px;
    padding:8px;
    color:#374151;
    font-size:13px;
  }
</style>

<script>
(function(){
  // Optional overrides (safe): window.OPULENCE = { baseId: 'app...', problemsTableId: 'tbl...' };
  const cfg = window.OPULENCE || {};

  // Use local Express when running via Live Server; otherwise use Vercel serverless route
  const isLocalStatic = ['localhost','127.0.0.1'].includes(location.hostname);
  const baseApi = isLocalStatic ? 'http://localhost:3000/api/problems' : '/api/problems';

  const getBtn = document.getElementById('getBtn');
  const statusEl = document.getElementById('status');
  const cards = document.getElementById('cards');

  function buildUrl() {
    const u = new URL(baseApi, window.location.origin);
    if (cfg.baseId) u.searchParams.set('baseId', cfg.baseId);
    if (cfg.problemsTableId) u.searchParams.set('problemsTableId', cfg.problemsTableId);
    if (cfg.problemsTableName) u.searchParams.set('problemsTableName', cfg.problemsTableName);
    return u.toString();
  }

  function escapeHTML(s){
    return String(s||"").replace(/[&<>"']/g, m => ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#039;'}[m]));
  }
  function fmtDate(d){
    if (!d) return '—';
    const t = new Date(d);
    return isNaN(t) ? '—' : t.toLocaleDateString([], { month:'short', day:'numeric', year:'numeric' });
  }
  function statusClass(s){
    const k = String(s||'').toLowerCase();
    if (k === 'open') return 'status-open';
    if (k === 'resolved') return 'status-resolved';
    return 'status-in-progress';
  }
  function severityClass(s){
    const k = String(s||'').toLowerCase();
    if (k === 'high') return 'sev-high';
    if (k === 'low') return 'sev-low';
    return 'sev-medium';
  }

  function renderCards(records){
    if (!Array.isArray(records) || records.length === 0){
      cards.innerHTML = '<p style="color:#6b7280;text-align:center;padding:12px;">No records found.</p>';
      return;
    }

    cards.innerHTML = records.map(r => {
      const f = r.fields || {};
      const pid = f['Problem ID'] || '';
      const type = f['Type'] || '';
      const desc = f['Description'] || '';
      const proj = f['Project'] || '';
      const reported = f['Reported Date'] || '';
      const status = f['Status'] || '';
      const severity = f['Severity'] || '';
      const assigned = f['Assigned to'] || '';

      return `
        <div class="problem-card">
          <div class="card-head">
            <div class="pid">${escapeHTML(pid)}</div>
            <div style="display:flex;gap:6px;align-items:center;">
              <span class="badge ${statusClass(status)}">${escapeHTML(status || '—')}</span>
              <span class="badge ${severityClass(severity)}">${escapeHTML(severity || '—')}</span>
            </div>
          </div>
          <div class="meta">
            <div><span>Type:</span> ${escapeHTML(type || '—')}</div>
            <div><span>Project:</span> ${escapeHTML(proj || '—')}</div>
            <div><span>Assigned:</span> ${escapeHTML(assigned || '—')}</div>
            <div><span>Reported:</span> ${escapeHTML(fmtDate(reported))}</div>
          </div>
          <div class="desc">${escapeHTML(desc || '—')}</div>
        </div>
      `;
    }).join('');
  }

  async function getProblems() {
    try {
      getBtn.disabled = true;
      getBtn.textContent = 'Loading…';
      statusEl.style.display = 'inline';
      statusEl.style.color = '#6b7280';
      statusEl.textContent = 'Fetching from API…';
      cards.innerHTML = '';

      const url = buildUrl();
      const r = await fetch(url, { cache: 'no-store' });
      if (!r.ok) {
        const txt = await r.text();
        throw new Error(`HTTP ${r.status}: ${txt}`);
      }
      const data = await r.json();

      // Pretty cards
      const records = data.records || [];
      renderCards(records);

      statusEl.style.color = '#059669';
      statusEl.textContent = `Done. ${records.length} records.`;
    } catch (e) {
      statusEl.style.color = '#e11d48';
      statusEl.textContent = `Error: ${e.message}`;
      cards.innerHTML = '';
      console.error(e);
    } finally {
      getBtn.disabled = false;
      getBtn.textContent = 'Get';
    }
  }

  getBtn.addEventListener('click', getProblems);
})();
</script>
    } finally {
      getBtn.disabled = false;
      getBtn.textContent = 'Get';
    }
  }

  getBtn.addEventListener('click', getProblems);
})();
</script>
