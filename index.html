<!DOCTYPE html>
<html lang="en">
<head>
  <script>
    // Simplified dashboard loader (reverted to workingindex.html pattern)
    window.OPULENCE = window.OPULENCE || {};
    const VIEW_MAP = {
      overview: 'Components/overview.html',
      schedule: 'Components/schedule.html',
      crew: 'Components/crew.html',
      problems: 'Components/problems.html'
    };
    const spaceEl = document.getElementById('dashboardSpace');
    const navEl = document.getElementById('topnav');

    async function loadDashboard(name){
      const file = VIEW_MAP[name];
      if(!file) return;
      // nav state
      navEl?.querySelectorAll('button').forEach(b=>b.classList.toggle('active', b.dataset.view===name));
      // loading placeholder
      spaceEl.innerHTML = `<div><div class="loader"></div><div style="color:#6b7280">Loading ${name}‚Ä¶</div></div>`;
      try {
        const r = await fetch(file,{cache:'no-store'});
        if(!r.ok) throw new Error(`Failed to load ${file} (${r.status})`);
        const html = await r.text();
        spaceEl.innerHTML = html;
        executeScripts(spaceEl);
        const AUTO_INIT = new Set(['crew','overview','schedule','problems']);
        if (AUTO_INIT.has(name)) setTimeout(()=>{ const btn=spaceEl.querySelector('#getBtn'); if(btn && !btn.disabled) btn.click(); },50);
        location.hash = `#/${name}`; // maintain hash
      } catch(e){
        spaceEl.innerHTML = `<div class="dashboard-placeholder"><div class="icon">‚ö†Ô∏è</div><p>Couldn't load <strong>${name}</strong>.</p><p style=\"color:#6b7280\">${e.message}</p></div>`;
      }
    }

    function executeScripts(container){
      container.querySelectorAll('script').forEach(sc=>{ const s=document.createElement('script'); if(sc.src) s.src=sc.src; else s.textContent=sc.innerHTML; document.body.appendChild(s); document.body.removeChild(s); });
    }
    window.loadDashboard = loadDashboard;
    navEl?.addEventListener('click', e=>{ const btn=e.target.closest('button[data-view]'); if(btn) loadDashboard(btn.dataset.view); });
    function bootFromHash(){ const m=location.hash.match(/^#\/(\w+)/); const v=m&&m[1]; if(v && VIEW_MAP[v]) loadDashboard(v); }
    window.addEventListener('hashchange', bootFromHash); bootFromHash();
    if(!location.hash) loadDashboard('overview');

    // Voice widget bridge & status
    function showVoiceStatus(msg){ const el=document.getElementById('voiceStatus'); if(!el) return; el.textContent=msg; el.classList.add('show'); setTimeout(()=>el.classList.remove('show'),3000);}    
    window.addEventListener('message', ev=>{ const d=ev.data; if(!d) return; if(d.type==='vapi-widget'){ if(d.event==='call-start') showVoiceStatus('üé§ Voice call started'); else if(d.event==='call-end') showVoiceStatus('üëã Voice call ended'); else if(d.event==='message' && d.message?.transcript) showVoiceStatus(`"${d.message.transcript}"`); } if(d.type==='opulence' && d.action==='loadDashboard'){ const v=String(d.name||'').toLowerCase(); if(VIEW_MAP[v]) loadDashboard(v); }});

    // Simple polling for /api/voice-intent
    (function(){
      const ALLOWED=new Set(['overview','schedule','crew','problems']);
      let lastUpdate=0;
      async function poll(){
        try{
          const u=new URL('/api/voice-intent', location.origin);
          if(lastUpdate) u.searchParams.set('since', lastUpdate);
          const res=await fetch(u.toString(),{cache:'no-store'});
          if(!res.ok) return;
          const j=await res.json();
            if(j.updatedAt && j.updatedAt>lastUpdate) lastUpdate=j.updatedAt;
            const view=String(j.view||'').toLowerCase();
            if(j.changed && ALLOWED.has(view)) loadDashboard(view);
        }catch(e){ console.warn('[voice] poll error', e.message); }
      }
      try{ clearInterval(window._voicePollTimer);}catch{}
      window._voicePollTimer=setInterval(poll,2000);
    })();

    // Manual tester
    window.voiceTest = async function(view){ try { const r=await fetch('/api/voice-intent',{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({view})}); const j=await r.json(); console.log('[voiceTest]', j); if(j.view && VIEW_MAP[j.view]) loadDashboard(j.view); } catch(e){ console.warn(e);} };

    console.log('Opulence Dashboard initialized (simplified mode)');
  </script>
</body>
</html>
