<div style="padding:16px;font-family:system-ui,Arial,sans-serif;">
  <h3>Schedule (Airtable)</h3>
  <p>Click “Get” to fetch live data from the Schedule table via the API.</p>

  <div style="margin-bottom:12px;">
    <button id="getBtn" style="padding:8px 12px;border:none;border-radius:8px;background:#4f46e5;color:#fff;cursor:pointer;">Get</button>
    <span id="status" style="margin-left:10px;color:#6b7280;display:none;"></span>
  </div>

  <div id="gantt_container" style="min-height:520px;background:#fff;border:1px solid #e5e7eb;border-radius:12px;padding:8px;">
    <div id="gantt_chart" style="width:100%;height:520px;"></div>
  </div>
</div>

<script type="text/javascript" src="https://www.gstatic.com/charts/loader.js"></script>
<script>
(function(){
  // Optional overrides (safe): window.OPULENCE = { baseId: 'app...', scheduleTableId: 'tbl...' };
  const cfg = window.OPULENCE || {};

  const isLocalStatic = ['localhost','127.0.0.1'].includes(location.hostname);
  const baseApi = isLocalStatic ? 'http://localhost:3000/api/schedule' : '/api/schedule';

  const getBtn = document.getElementById('getBtn');
  const statusEl = document.getElementById('status');
  const ganttEl = document.getElementById('gantt_chart');

  function buildUrl() {
    const u = new URL(baseApi, window.location.origin);
    if (cfg.baseId) u.searchParams.set('baseId', cfg.baseId);
    if (cfg.scheduleTableId) u.searchParams.set('scheduleTableId', cfg.scheduleTableId);
    if (cfg.scheduleTableName) u.searchParams.set('scheduleTableName', cfg.scheduleTableName);
    return u.toString();
  }

  function clamp(n, min, max){ return Math.max(min, Math.min(max, n)); }
  function daysToMilliseconds(days) { return days * 24 * 60 * 60 * 1000; }

  // Parse "YYYY-MM-DD" (or any string Date) safely into a local Date (no TZ shifts)
  function parseYMD(value){
    if (!value) return null;
    if (value instanceof Date) return isNaN(value) ? null : value;
    if (typeof value === 'number') return new Date(value);
    const s = String(value).trim();
    // Expect "YYYY-MM-DD"
    const m = /^(\d{4})-(\d{2})-(\d{2})$/.exec(s);
    if (m) {
      const y = +m[1], mo = +m[2] - 1, d = +m[3];
      const dt = new Date(y, mo, d);
      return isNaN(dt) ? null : dt;
    }
    const dt = new Date(s);
    return isNaN(dt) ? null : dt;
  }

  function toDataTable(tasks){
    const data = new google.visualization.DataTable();
    data.addColumn('string', 'Task ID');
    data.addColumn('string', 'Task Name');
    data.addColumn('string', 'Resource');
    data.addColumn('date', 'Start Date');
    data.addColumn('date', 'End Date');
    data.addColumn('number', 'Duration');
    data.addColumn('number', 'Percent Complete');
    data.addColumn('string', 'Dependencies');

    const rows = [];
    for (const t of tasks) {
      const start = parseYMD(t.startDate) || new Date();
      let end = parseYMD(t.endDate);
      if (!end || end <= start) {
        end = new Date(start.getTime() + daysToMilliseconds(1));
      }
      const pct = clamp(Number.isFinite(+t.percentComplete) ? +t.percentComplete : 0, 0, 100);

      rows.push([
        t.taskId || t.id || String(rows.length + 1),
        t.name || '',
        t.project || '',
        start,
        end,
        null, // duration is computed from start/end
        pct,
        t.dependencies || null
      ]);
    }

    if (!rows.length) return data;
    data.addRows(rows);
    return data;
  }

  function drawGantt(tasks){
    const chartData = toDataTable(tasks);
    const options = {
      height: Math.max(200, 60 + tasks.length * 42),
      gantt: {
        trackHeight: 38,
        percentEnabled: true
      }
    };
    try {
      const chart = new google.visualization.Gantt(ganttEl);
      chart.draw(chartData, options);
    } catch (err) {
      console.error('Gantt draw error:', err);
      statusEl.style.display = 'inline';
      statusEl.style.color = '#e11d48';
      statusEl.textContent = `Error drawing chart: ${err.message}`;
    }
  }

  async function getSchedule() {
    try {
      getBtn.disabled = true;
      getBtn.textContent = 'Loading…';
      statusEl.style.display = 'inline';
      statusEl.style.color = '#6b7280';
      statusEl.textContent = 'Fetching from API…';

      const url = buildUrl();
      const r = await fetch(url, { cache: 'no-store' });
      if (!r.ok) {
        const txt = await r.text();
        throw new Error(`HTTP ${r.status}: ${txt}`);
      }
      const data = await r.json();
      const tasks = data.tasks || [];

      if (typeof google !== 'undefined' && google.charts) {
        if (!google.visualization || !google.visualization.Gantt) {
          google.charts.load('current', { packages: ['gantt'] });
          google.charts.setOnLoadCallback(() => drawGantt(tasks));
        } else {
          drawGantt(tasks);
        }
      } else {
        google.charts.load('current', { packages: ['gantt'] });
        google.charts.setOnLoadCallback(() => drawGantt(tasks));
      }

      statusEl.style.color = '#059669';
      statusEl.textContent = `Done. ${tasks.length} tasks.`;
    } catch (e) {
      statusEl.style.color = '#e11d48';
      statusEl.textContent = `Error: ${e.message}`;
      console.error(e);
    } finally {
      getBtn.disabled = false;
      getBtn.textContent = 'Get';
    }
  }

  getBtn.addEventListener('click', getSchedule);
})();
</script>
