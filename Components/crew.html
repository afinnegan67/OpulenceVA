<div style="padding:16px;font-family:system-ui,Arial,sans-serif;">
  <h3>Crew (Airtable)</h3>
  <p>Click “Get” to fetch live data from the Crew table via the API.</p>

  <div style="margin-bottom:12px;">
    <button id="getBtn" style="padding:8px 12px;border:none;border-radius:8px;background:#4f46e5;color:#fff;cursor:pointer;">Get</button>
    <span id="status" style="margin-left:10px;color:#6b7280;display:none;"></span>
  </div>

  <div id="cards" class="crew-cards"></div>
</div>

<style>
  .crew-cards {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(280px, 1fr));
    gap: 12px;
    margin-top: 8px;
  }
  .crew-card {
    background: #fff;
    border: 1px solid #e5e7eb;
    border-radius: 12px;
    padding: 12px;
    box-shadow: 0 4px 12px rgba(0,0,0,.04);
  }
  .crew-card .head {
    display: flex;
    align-items: center;
    gap: 10px;
    margin-bottom: 8px;
  }
  .crew-card .avatar {
    width: 40px; height: 40px; border-radius: 999px;
    display: inline-flex; align-items: center; justify-content: center;
    background: #eef2ff; color: #4f46e5; font-weight: 700;
  }
  .crew-card .name { font-weight: 700; color: #111827; }
  .crew-card .role { color: #6b7280; font-size: 13px; }
  .badge {
    display: inline-block; font-size: 12px; padding: 2px 8px;
    border-radius: 999px; color: #fff; line-height: 1.6; white-space: nowrap;
  }
  .badge.status-active { background:#059669; }
  .badge.status-inactive { background:#6b7280; }
  .meta {
    display: grid;
    grid-template-columns: 1fr 1fr;
    gap: 6px 12px;
    font-size: 13px;
    color:#374151;
    margin: 8px 0;
  }
  .meta div span { color:#6b7280; }
  .chips { display:flex; flex-wrap:wrap; gap:6px; margin-top: 4px; }
  .chip {
    background:#f3f4f6; border:1px solid #e5e7eb; color:#374151;
    border-radius:999px; padding:2px 8px; font-size:12px;
  }
  .contact a { color:#4f46e5; text-decoration:none; }
  .contact a:hover { text-decoration:underline; }
</style>

<script>
(function(){
  // Optional overrides (safe): window.OPULENCE = { baseId: 'app...', crewTableId: 'tbl...' };
  const cfg = window.OPULENCE || {};

  // Use local Express in Live Server; otherwise use Vercel serverless route
  const isLocalStatic = ['localhost','127.0.0.1'].includes(location.hostname);
  const baseApi = isLocalStatic ? 'http://localhost:3000/api/crew' : '/api/crew';

  const getBtn = document.getElementById('getBtn');
  const statusEl = document.getElementById('status');
  const cards = document.getElementById('cards');

  function buildUrl() {
    const u = new URL(baseApi, window.location.origin);
    if (cfg.baseId) u.searchParams.set('baseId', cfg.baseId);
    if (cfg.crewTableId) u.searchParams.set('crewTableId', cfg.crewTableId);
    if (cfg.crewTableName) u.searchParams.set('crewTableName', cfg.crewTableName);
    return u.toString();
  }

  function escapeHTML(s){
    return String(s||"").replace(/[&<>"']/g, m => ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#039;'}[m]));
  }
  function initials(name){
    const parts = String(name||'').trim().split(/\s+/).slice(0,2);
    return parts.map(p => p[0]?.toUpperCase() || '').join('') || 'C';
  }
  function statusClass(s){
    const k = String(s||'').toLowerCase();
    return k === 'active' ? 'status-active' : 'status-inactive';
  }
  function toChips(skills){
    if (!skills) return [];
    if (Array.isArray(skills)) return skills;
    return String(skills).split(',').map(x => x.trim()).filter(Boolean);
  }

  function renderCards(records){
    if (!Array.isArray(records) || records.length === 0){
      cards.innerHTML = '<p style="color:#6b7280;text-align:center;padding:12px;">No crew found.</p>';
      return;
    }

    cards.innerHTML = records.map(r => {
      const f = r.fields || {};
      const crewId = f['Crew ID'] || '';
      const name = f['Name'] || '';
      const role = f['Role'] || '';
      const skills = toChips(f['Skills']);
      const project = f['Current Project'] || '';
      const status = f['Status'] || '';
      const contact = f['Contact'] || '';

      const mailLink = contact && contact.includes('@') ? `<a href="mailto:${escapeHTML(contact)}">${escapeHTML(contact)}</a>` : escapeHTML(contact);

      return `
        <div class="crew-card">
          <div class="head">
            <div class="avatar">${escapeHTML(initials(name))}</div>
            <div>
              <div class="name">${escapeHTML(name || '—')}</div>
              <div class="role">${escapeHTML(role || '—')}</div>
            </div>
            <div style="margin-left:auto;">
              <span class="badge ${statusClass(status)}">${escapeHTML(status || '—')}</span>
            </div>
          </div>

          <div class="meta">
            <div><span>Crew ID:</span> ${escapeHTML(crewId || '—')}</div>
            <div><span>Project:</span> ${escapeHTML(project || '—')}</div>
          </div>

          <div class="chips">
            ${skills.map(s => `<span class="chip">${escapeHTML(s)}</span>`).join('')}
          </div>

          <div class="contact" style="margin-top:8px;">
            <span style="color:#6b7280;">Contact:</span> ${mailLink || '—'}
          </div>
        </div>
      `;
    }).join('');
  }

  async function getCrew() {
    try {
      getBtn.disabled = true;
      getBtn.textContent = 'Loading…';
      statusEl.style.display = 'inline';
      statusEl.style.color = '#6b7280';
      statusEl.textContent = 'Fetching from API…';
      cards.innerHTML = '';

      const url = buildUrl();
      const r = await fetch(url, { cache: 'no-store' });
      if (!r.ok) {
        const txt = await r.text();
        throw new Error(`HTTP ${r.status}: ${txt}`);
      }
      const data = await r.json();
      const records = data.records || [];
      renderCards(records);

      statusEl.style.color = '#059669';
      statusEl.textContent = `Done. ${records.length} crew.`;
    } catch (e) {
      statusEl.style.color = '#e11d48';
      statusEl.textContent = `Error: ${e.message}`;
      cards.innerHTML = '';
      console.error(e);
    } finally {
      getBtn.disabled = false;
      getBtn.textContent = 'Get';
    }
  }

  getBtn.addEventListener('click', getCrew);
})();
</script>

<script>
  let lastUpdate = 0;

  async function checkViewChange() {
    try {
      const res = await fetch('/api/voice-intent?since=' + lastUpdate);
      const data = await res.json();

      if (data.changed) {
        lastUpdate = data.updatedAt;
        console.log("Switching to:", data.view);
        window.location.href = data.view + '.html';
      }
    } catch (err) {
      console.error('Error checking view change:', err);
    }
  }

  setInterval(checkViewChange, 2000);
</script>
