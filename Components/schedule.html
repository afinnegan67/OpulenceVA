<div class="sch-wrap">
  <div class="sch-head glass">
    <div>
      <h3>Schedule</h3>
      <p>Live calendar from Airtable</p>
    </div>
    <div class="controls">
      <button id="getBtn" class="btn">Refresh</button>
      <span id="status" class="status" style="display:none;"></span>
      <div class="nav">
        <button id="prevBtn" class="btn alt">‹</button>
        <strong id="monthLabel" class="month"></strong>
        <button id="nextBtn" class="btn alt">›</button>
        <button id="todayBtn" class="btn alt">Today</button>
      </div>
    </div>
  </div>

  <div class="glass panel" style="margin-bottom:12px;">
    <div class="filters">
      <label>
        <span>Project</span>
        <select id="filterProject">
          <option value="">All</option>
        </select>
      </label>
      <label>
        <span>Crew</span>
        <select id="filterCrew">
          <option value="">All</option>
        </select>
      </label>
    </div>
  </div>

  <div class="calendar panel glass">
    <div class="cal-weekdays">
      <div>Sun</div><div>Mon</div><div>Tue</div><div>Wed</div><div>Thu</div><div>Fri</div><div>Sat</div>
    </div>
    <div id="calGrid" class="cal-grid"></div>
  </div>

  <div id="details" class="details glass" hidden>
    <div class="details-head">
      <div>
        <h4 id="detailsTitle">Day</h4>
        <p id="detailsSub"></p>
      </div>
      <button id="closeDetails" class="btn alt">Close</button>
    </div>
    <div id="detailsBody" class="details-body"></div>
  </div>
</div>

<style>
  .sch-wrap { font-family: system-ui, Arial, sans-serif; color:#e5e7eb; }
  .sch-head {
    display:flex; align-items:center; justify-content:space-between;
    margin-bottom:14px; padding:14px 16px; border-radius:16px;
  }
  .sch-head h3 { margin:0; font-size:1.25rem; color:#dbeafe; letter-spacing:.2px; }
  .sch-head p { margin:2px 0 0; font-size:.9rem; color:#a5b4fc; }
  .controls { display:flex; gap:10px; align-items:center; flex-wrap:wrap; }
  .nav { display:flex; gap:8px; align-items:center; }
  .month { min-width:180px; text-align:center; color:#e5e7eb; }

  .glass {
    background: rgba(255,255,255,0.08);
    border: 1px solid rgba(255,255,255,0.18);
    backdrop-filter: blur(14px) saturate(120%);
    box-shadow: inset 0 1px 0 rgba(255,255,255,0.06), 0 14px 44px rgba(0,0,0,0.28), 0 2px 10px rgba(0,0,0,0.18);
    position: relative;
  }
  .glass::before {
    content:""; position:absolute; inset:0; border-radius:inherit; pointer-events:none;
    background:
      linear-gradient(180deg, rgba(255,255,255,.10), transparent 30%),
      linear-gradient(90deg, rgba(255,255,255,.05), transparent 40% 60%, rgba(255,255,255,.04));
  }
  .panel { padding:14px; border-radius:16px; }

  .btn {
    appearance:none; border:1px solid rgba(255,255,255,.22); color:#0b1021; font-weight:700;
    background: linear-gradient(135deg, #60a5fa 0%, #8b5cf6 100%);
    padding:8px 12px; border-radius:10px; cursor:pointer;
  }
  .btn.alt{
    background: rgba(255,255,255,0.10); color:#e5e7eb; text-shadow:none;
    border: 1px solid rgba(255,255,255,0.18);
  }
  .btn:disabled{ opacity:.6; cursor:not-allowed; }
  .status { font-size:.9rem; color:#a5b4fc; }

  .filters { display:flex; gap:12px; flex-wrap:wrap; align-items:end; }
  .filters label { display:grid; gap:6px; color:#cbd5e1; font-size:.9rem; }
  .filters select {
    background: rgba(255,255,255,.06); color:#e5e7eb; border:1px solid rgba(255,255,255,.18);
    border-radius:10px; padding:8px 10px; outline:none;
  }

  .calendar { overflow:hidden; }
  .cal-weekdays {
    display:grid; grid-template-columns: repeat(7, 1fr); gap:8px; margin-bottom:8px;
    color:#a5b4fc; font-size:12px; text-transform:uppercase; letter-spacing:.04em;
  }
  .cal-grid { display:grid; grid-template-columns: repeat(7, 1fr); gap:8px; }
  .cal-day {
    min-height:130px; border:1px solid rgba(255,255,255,.16); border-radius:12px; padding:10px;
    background: rgba(255,255,255,.04);
    display:flex; flex-direction:column; gap:6px;
    transition: transform .08s ease, background .15s ease, border-color .15s ease;
    cursor:pointer;
  }
  .cal-day:hover { transform: translateY(-1px); background: rgba(255,255,255,.06); border-color: rgba(255,255,255,.28); }
  .cal-day.other-month { background: rgba(255,255,255,.03); color:#9ca3af; }
  .cal-day .date {
    font-size:12px; color:#cbd5e1; display:flex; justify-content:space-between; align-items:center;
  }
  .count {
    font-size:11px; color:#0b1021; background:#dbeafe; padding:2px 6px; border-radius:999px; border:1px solid rgba(255,255,255,.22);
  }
  .pill {
    display:block; padding:4px 6px; border-radius:8px; font-size:12px; color:#0b1021; background:#eef2ff; border:1px solid rgba(255,255,255,.22);
    white-space:nowrap; overflow:hidden; text-overflow:ellipsis;
  }
  .more { font-size:12px; color:#a5b4fc; }

  .details {
    margin-top:12px; padding:0; overflow:hidden;
  }
  .details[hidden]{ display:none; }
  .details-head {
    display:flex; align-items:center; justify-content:space-between; gap:12px;
    padding:12px 14px; border-bottom:1px solid rgba(255,255,255,.12);
  }
  .details-head h4 { margin:0; color:#dbeafe; }
  .details-head p { margin:4px 0 0; color:#a5b4fc; font-size:.9rem; }
  .details-body { padding:12px 14px; display:grid; gap:8px; }
  .task-row {
    display:grid; grid-template-columns: 1.6fr 1fr 1.2fr 80px; gap:10px; align-items:center;
    padding:10px; border-radius:12px; background: rgba(255,255,255,.06); border:1px solid rgba(255,255,255,.14);
  }
  .task-title { color:#e5e7eb; font-weight:600; }
  .task-meta { color:#cbd5e1; font-size:.9rem; }
  .task-dates { color:#a5b4fc; font-size:.9rem; }
  .mini-progress { height:8px; border-radius:999px; overflow:hidden; background:rgba(255,255,255,.08); border:1px solid rgba(255,255,255,.14); }
  .mini-progress > span { display:block; height:100%; background: linear-gradient(90deg, #60a5fa, #8b5cf6); }
  @media (max-width: 820px){
    .task-row { grid-template-columns: 1fr; }
  }
</style>

<script>
(function(){
  const cfg = window.OPULENCE || {};
  const isLocalStatic = ['localhost','127.0.0.1'].includes(location.hostname);
  const baseApi = isLocalStatic ? 'http://localhost:3000/api/schedule' : '/api/schedule';

  const getBtn = document.getElementById('getBtn');
  const statusEl = document.getElementById('status');
  const monthLabel = document.getElementById('monthLabel');
  const prevBtn = document.getElementById('prevBtn');
  const nextBtn = document.getElementById('nextBtn');
  const todayBtn = document.getElementById('todayBtn');
  const calGrid = document.getElementById('calGrid');
  const filterProject = document.getElementById('filterProject');
  const filterCrew = document.getElementById('filterCrew');
  const detailsEl = document.getElementById('details');
  const detailsTitle = document.getElementById('detailsTitle');
  const detailsSub = document.getElementById('detailsSub');
  const detailsBody = document.getElementById('detailsBody');
  const closeDetails = document.getElementById('closeDetails');

  let TASKS = [];
  let currentMonth = firstOfMonth(new Date());
  let selectedDate = null;

  function buildUrl() {
    const u = new URL(baseApi, window.location.origin);
    if (cfg.baseId) u.searchParams.set('baseId', cfg.baseId);
    if (cfg.scheduleTableId) u.searchParams.set('scheduleTableId', cfg.scheduleTableId);
    if (cfg.scheduleTableName) u.searchParams.set('scheduleTableName', cfg.scheduleTableName);
    return u.toString();
  }

  // Helpers
  function firstOfMonth(d){ return new Date(d.getFullYear(), d.getMonth(), 1); }
  function addMonths(d, n){ return new Date(d.getFullYear(), d.getMonth() + n, 1); }
  function fmtMonth(d){ return d.toLocaleDateString([], { month:'long', year:'numeric' }); }
  function clamp(n, min, max){ return Math.max(min, Math.min(max, n)); }
  function fmtDate(d){ if (!d) return '—'; const t=new Date(d); return isNaN(t)?'—':t.toLocaleDateString([], {month:'short', day:'numeric'}); }

  function parseDate(value){
    if (!value) return null;
    if (value instanceof Date) return isNaN(value) ? null : value;
    if (typeof value === 'number') return new Date(value);
    const s = String(value).trim();
    let m = /^(\d{4})-(\d{2})-(\d{2})$/.exec(s);
    if (m) { const dt = new Date(+m[1], +m[2]-1, +m[3]); return isNaN(dt) ? null : dt; }
    m = /^(\d{1,2})\/(\d{1,2})\/(\d{4})$/.exec(s);
    if (m) { const dt = new Date(+m[3], +m[1]-1, +m[2]); return isNaN(dt) ? null : dt; }
    const dt = new Date(s); return isNaN(dt) ? null : dt;
  }
  function parsePercent(v){
    if (typeof v === 'number') return v <= 1 ? Math.round(v * 100) : Math.round(v);
    if (typeof v === 'string') {
      const t = v.trim();
      if (t.endsWith('%')) return clamp(parseFloat(t.slice(0,-1)) || 0, 0, 100);
      const n = parseFloat(t);
      if (!isNaN(n)) return n <= 1 ? Math.round(n*100) : Math.round(n);
    }
    return 0;
  }
  function colorForString(s){
    const str = String(s||'Project'); let h = 0;
    for (let i=0;i<str.length;i++){ h = (h*31 + str.charCodeAt(i)) % 360; }
    return {
      bg: `hsl(${h} 85% 92%)`,
      border: `hsl(${h} 40% 68%)`
    };
  }
  function escapeHTML(s){ return String(s||"").replace(/[&<>"']/g, m => ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#039;'}[m])); }

  function visibleTasks(tasks){
    const proj = filterProject.value;
    const crew = filterCrew.value;
    return tasks.filter(t => {
      if (proj && String(t.project||'') !== proj) return false;
      if (crew && String(t.crew||'') !== crew) return false;
      return true;
    });
  }

  function tasksOnDay(tasks, day){
    const dd = new Date(day.getFullYear(), day.getMonth(), day.getDate());
    return tasks.filter(t => {
      const s = parseDate(t.startDate);
      const e0 = parseDate(t.endDate);
      if (!s) return false;
      const e = e0 && e0 >= s ? e0 : s; // 1-day if end missing/invalid
      const d0 = new Date(s.getFullYear(), s.getMonth(), s.getDate());
      const d1 = new Date(e.getFullYear(), e.getMonth(), e.getDate());
      return d0 <= dd && dd <= d1;
    });
  }

  function populateFilters(){
    const projs = new Set(), crews = new Set();
    for (const t of TASKS){
      if (t.project) projs.add(String(t.project));
      if (t.crew) crews.add(String(t.crew));
    }
    const projVal = filterProject.value, crewVal = filterCrew.value;
    filterProject.innerHTML = `<option value="">All</option>` + [...projs].sort().map(p=>`<option ${p===projVal?'selected':''}>${escapeHTML(p)}</option>`).join('');
    filterCrew.innerHTML = `<option value="">All</option>` + [...crews].sort().map(c=>`<option ${c===crewVal?'selected':''}>${escapeHTML(c)}</option>`).join('');
  }

  function renderCalendar(){
    monthLabel.textContent = fmtMonth(currentMonth);
    const start = firstOfMonth(currentMonth);
    const end = new Date(start.getFullYear(), start.getMonth()+1, 0);
    const startWeekDay = new Date(start.getFullYear(), start.getMonth(), 1).getDay();
    const gridStart = new Date(start); gridStart.setDate(1 - startWeekDay);
    const gridEnd = new Date(end); gridEnd.setDate(end.getDate() + (6 - end.getDay()));

    const tasks = visibleTasks(TASKS);
    let html = '';
    for (let d = new Date(gridStart); d <= gridEnd; d.setDate(d.getDate()+1)) {
      const day = new Date(d);
      const other = !(day.getFullYear() === start.getFullYear() && day.getMonth() === start.getMonth());
      const dayTasks = tasksOnDay(tasks, day);
      const top3 = dayTasks.slice(0,3);
      const more = dayTasks.length - top3.length;

      const items = top3.map(t => {
        const { bg, border } = colorForString(t.project);
        const pct = parsePercent(t.percentComplete);
        const name = (t.name || t.taskId || t.id || '').toString();
        return `<span class="pill" title="${escapeHTML(name)} (${pct}% • ${escapeHTML(t.project||'')})" style="background:${bg};border-color:${border};">${escapeHTML(name)}</span>`;
      }).join('');

      html += `
        <div class="cal-day ${other ? 'other-month':''}" data-date="${day.toISOString()}">
          <div class="date">
            <span>${day.getDate()}</span>
            <span class="count">${dayTasks.length}</span>
          </div>
          <div class="items" style="display:flex;flex-direction:column;gap:4px;">
            ${items || '<span class="more" style="visibility:hidden;">&nbsp;</span>'}
            ${more > 0 ? `<span class="more">+${more} more</span>` : ''}
          </div>
        </div>
      `;
    }
    calGrid.innerHTML = html;

    // bind clicks for details
    calGrid.querySelectorAll('.cal-day').forEach(el => {
      el.addEventListener('click', () => {
        const iso = el.getAttribute('data-date');
        const day = new Date(iso);
        showDetails(day, tasksOnDay(tasks, day));
      });
    });
  }

  function showDetails(day, tasks){
    selectedDate = new Date(day.getFullYear(), day.getMonth(), day.getDate());
    detailsTitle.textContent = selectedDate.toLocaleDateString([], { weekday:'long', month:'long', day:'numeric' });
    detailsSub.textContent = `${tasks.length} task${tasks.length===1?'':'s'}`;
    if (!tasks.length){
      detailsBody.innerHTML = `<div style="color:#a5b4fc;">No tasks on this day.</div>`;
    } else {
      detailsBody.innerHTML = tasks.map(t => {
        const pct = parsePercent(t.percentComplete);
        const dates = `${fmtDate(t.startDate)} — ${fmtDate(t.endDate)}`;
        const crew = escapeHTML(t.crew || '—');
        const project = escapeHTML(t.project || '—');
        const name = escapeHTML(t.name || t.taskId || t.id || '—');
        return `
          <div class="task-row">
            <div class="task-title">${name}<div class="task-meta">Project: ${project} • Crew: ${crew}</div></div>
            <div class="task-dates">${dates}</div>
            <div class="task-meta">${pct}% complete</div>
            <div class="mini-progress" title="${pct}%"><span style="width:${pct}%"></span></div>
          </div>
        `;
      }).join('');
    }
    detailsEl.hidden = false;
    detailsEl.scrollIntoView({ behavior:'smooth', block:'nearest' });
  }

  async function getSchedule() {
    try {
      getBtn.disabled = true;
      getBtn.textContent = 'Loading…';
      statusEl.style.display = 'inline';
      statusEl.style.color = '#a5b4fc';
      statusEl.textContent = 'Fetching from API…';

      const url = buildUrl();
      const r = await fetch(url, { cache: 'no-store' });
      if (!r.ok) {
        const txt = await r.text();
        throw new Error(`HTTP ${r.status}: ${txt}`);
      }
      const data = await r.json();
      const tasks = Array.isArray(data.tasks) ? data.tasks : [];

      // Normalize minimally and keep only valid ones with a start date
      TASKS = tasks.filter(t => parseDate(t.startDate));

      // Choose the month to display (earliest task start or current month)
      const minStart = TASKS.reduce((acc, t) => {
        const s = parseDate(t.startDate);
        return s && (!acc || s < acc) ? s : acc;
      }, null);
      currentMonth = firstOfMonth(minStart || new Date());

      populateFilters();
      renderCalendar();

      statusEl.style.display = 'inline';
      statusEl.style.color = '#86efac';
      statusEl.textContent = `Done. ${TASKS.length} tasks loaded.`;
    } catch (e) {
      statusEl.style.display = 'inline';
      statusEl.style.color = '#fca5a5';
      statusEl.textContent = `Error: ${e.message}`;
      console.error(e);
      calGrid.innerHTML = '';
      detailsEl.hidden = true;
    } finally {
      getBtn.disabled = false;
      getBtn.textContent = 'Refresh';
    }
  }

  // Events
  prevBtn?.addEventListener('click', () => { currentMonth = addMonths(currentMonth, -1); renderCalendar(); });
  nextBtn?.addEventListener('click', () => { currentMonth = addMonths(currentMonth, 1); renderCalendar(); });
  todayBtn?.addEventListener('click', () => { currentMonth = firstOfMonth(new Date()); renderCalendar(); });
  filterProject.addEventListener('change', () => { renderCalendar(); detailsEl.hidden = true; });
  filterCrew.addEventListener('change', () => { renderCalendar(); detailsEl.hidden = true; });
  getBtn.addEventListener('click', getSchedule);
  closeDetails.addEventListener('click', () => { detailsEl.hidden = true; });

})();
</script>
